<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS V8 — Scanner + Auto-fill (Demo)</title>
<link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:#f6f7fb;color:#222}
  .wrap{max-width:980px;margin:14px auto;padding:12px}
  h1{margin:6px 0 12px;font-size:20px}
  .panel{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
  #videoBox{width:100%;height:280px;background:#000;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  #videoEl{width:100%;height:100%;object-fit:cover}
  .controls{margin-top:8px}
  button{padding:8px 12px;border-radius:8px;border:0;background:#19a085;color:#fff;margin-right:8px}
  button.secondary{background:#253746}
  label{display:block;margin-top:8px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px}
  .row{display:flex;gap:8px}
  .col{flex:1}
  .detected{margin-top:8px;font-weight:700}
  .hint{font-size:13px;color:#666}
  .success{color:green}
  .error{color:red}
  .small{font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>POS V8 — Scanner + Auto-fill (Demo)</h1>

  <div class="panel">
    <div id="videoBox">
      <video id="videoEl" playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
      <div id="blocked" style="color:#fff;display:none">Camera blocked / waiting for permission</div>
    </div>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" class="secondary">Stop</button>
      <button id="clearBtn">Clear</button>
      <span class="hint"> (Back camera preferred)</span>
    </div>
    <div class="detected">Detected: <span id="detText">—</span></div>
    <div id="status" class="small hint"></div>
  </div>

  <div class="panel">
    <label>Barcode or scan result</label>
    <div class="row">
      <input id="barcodeInput" placeholder="Barcode / scan code">
      <button id="useBtn">Use</button>
    </div>

    <label>Auto-fill Product</label>
    <div class="row">
      <div class="col">
        <input id="pName" placeholder="Name">
        <input id="pCategory" placeholder="Category">
        <input id="pPrice" placeholder="Price">
      </div>
      <div class="col">
        <input id="pCost" placeholder="Cost">
        <input id="pStocks" placeholder="Stocks">
        <label>Markup % (quick)</label>
        <select id="markup">
          <option value="0">No markup</option>
          <option value="10">10%</option>
          <option value="15">15%</option>
          <option value="20">20%</option>
        </select>
        <button id="applyMarkup" style="margin-top:6px">Apply Markup</button>
      </div>
    </div>
    <div style="margin-top:10px" class="hint">Auto-fill uses demo DB. You can edit products later.</div>
  </div>

  <div class="panel">
    <label>Sample product DB (demo)</label>
    <pre id="dbPreview" style="white-space:pre-wrap;background:#f3f6f8;padding:8px;border-radius:6px">
Barcode,Name,Category,Cost,Price,Stocks
8906000000012,Nescafe Creamy White,Drinks,10,12,20
1234567890128,Lucky Me Pancit Canton,Instant,12,15,30
4899876543210,Cola 330ml,Drinks,8,10,50
9780201379624,Notebook A5,Stationery,25,35,10
7702010012345,Toothpaste 50g,Personal Care,20,30,25
5000112548167,Detergent 1kg,Household,40,55,12
    </pre>
  </div>

  <div class="panel">
    <label>Logs</label>
    <pre id="log" style="height:140px;overflow:auto;background:#fff;padding:8px;border-radius:6px"></pre>
  </div>
</div>

<!-- ZXing library (browser build) -->
<script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

<script>
/*
 POS V8 demo:
 - prefer BarcodeDetector (if available)
 - fallback to ZXing Browser
 - back camera preferred
 - auto-fill from sample DB above
*/

const video = document.getElementById('videoEl');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const clearBtn = document.getElementById('clearBtn');
const detText = document.getElementById('detText');
const barcodeInput = document.getElementById('barcodeInput');
const useBtn = document.getElementById('useBtn');
const logEl = document.getElementById('log');
const status = document.getElementById('status');

const pName = document.getElementById('pName');
const pCategory = document.getElementById('pCategory');
const pPrice = document.getElementById('pPrice');
const pCost = document.getElementById('pCost');
const pStocks = document.getElementById('pStocks');
const markup = document.getElementById('markup');
const applyMarkup = document.getElementById('applyMarkup');

let stream = null;
let scanning = false;
let scanner = null;
let useZXing = false;
let lastDetected = null;

// demo DB: array of product objects
const demoProducts = [
  { barcode:"8906000000012", name:"Nescafe Creamy White", category:"Drinks", cost:10, price:12, stocks:20 },
  { barcode:"1234567890128", name:"Lucky Me Pancit Canton", category:"Instant", cost:12, price:15, stocks:30 },
  { barcode:"4899876543210", name:"Cola 330ml", category:"Drinks", cost:8, price:10, stocks:50 },
  { barcode:"9780201379624", name:"Notebook A5", category:"Stationery", cost:25, price:35, stocks:10 },
  { barcode:"7702010012345", name:"Toothpaste 50g", category:"Personal Care", cost:20, price:30, stocks:25 },
  { barcode:"5000112548167", name:"Detergent 1kg", category:"Household", cost:40, price:55, stocks:12 },
];

function log(msg){ logEl.textContent += new Date().toLocaleTimeString() + " — " + msg + "\\n"; logEl.scrollTop = logEl.scrollHeight; }

async function startCamera(){
  stopCamera();
  status.textContent = "Starting camera…";
  // prefer back camera
  const constraintsPrefer = {
    audio:false,
    video: { facingMode: { exact: "environment" } }
  };
  const constraintsFallback = {
    audio:false,
    video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} }
  };
  try{
    try { stream = await navigator.mediaDevices.getUserMedia(constraintsPrefer); }
    catch(e){ stream = await navigator.mediaDevices.getUserMedia(constraintsFallback); }
    video.srcObject = stream;
    await video.play();
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    scanning = true;
    status.textContent = "Camera running. Scanning...";
    log("Camera started (width:"+video.videoWidth+",height:"+video.videoHeight+")");
    // choose scan method: BarcodeDetector or ZXing
    if(window.BarcodeDetector){
      try{
        const formats = await BarcodeDetector.getSupportedFormats();
        log("BarcodeDetector supported formats: " + formats.join(","));
        runBarcodeDetector();
      } catch(e){
        log("BarcodeDetector error: "+e);
        useZXing = true;
        runZXing();
      }
    } else {
      useZXing = true;
      runZXing();
    }
  } catch(err){
    status.textContent = "Camera error: " + (err.message || err);
    log("Camera permission/error: " + err);
    document.getElementById('blocked').style.display = 'block';
  }
}

function stopCamera(){
  scanning = false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
    video.srcObject = null;
    log("Camera stopped");
  }
  if(scanner && scanner.reset) try{ scanner.reset(); }catch(e){}
}

function clearDetected(){
  lastDetected = null;
  detText.textContent = '—';
  barcodeInput.value = "";
  status.textContent = "";
}

startBtn.onclick = ()=>startCamera();
stopBtn.onclick = ()=>stopCamera();
clearBtn.onclick = ()=>clearDetected();

useBtn.onclick = ()=>{
  const code = barcodeInput.value.trim();
  if(!code) return;
  fillFromBarcode(code);
};

// MARKUP
applyMarkup.onclick = ()=>{
  const p = parseFloat(pCost.value) || 0;
  const m = parseFloat(markup.value) || 0;
  const price = Math.round((p * (1 + m/100)) * 100) / 100;
  pPrice.value = price;
  status.textContent = "Markup applied: " + m + "% → price " + price;
};

// Auto-fill logic
function fillFromBarcode(code){
  const prod = demoProducts.find(p=>p.barcode === code);
  if(prod){
    pName.value = prod.name;
    pCategory.value = prod.category;
    pCost.value = prod.cost;
    pPrice.value = prod.price;
    pStocks.value = prod.stocks;
    status.textContent = "Product auto-filled from demo DB";
    log("Auto-filled product: " + prod.name + " ("+code+")");
  } else {
    status.textContent = "Barcode not found in demo DB: " + code;
    log("Barcode not found: " + code);
  }
}

// BarcodeDetector usage
let detector = null;
async function runBarcodeDetector(){
  try{
    detector = new BarcodeDetector({formats: ['ean_13','ean_8','code_128','qr_code','upc_a','upc_e']});
    scanLoopBarcodeDetector();
  }catch(e){
    log("Failed to create BarcodeDetector: "+e);
    useZXing = true;
    runZXing();
  }
}
async function scanLoopBarcodeDetector(){
  if(!scanning) return;
  try{
    const bitmap = await createImageBitmap(video);
    const detections = await detector.detect(bitmap);
    if(detections && detections.length) {
      const code = detections[0].rawValue;
      if(code && code !== lastDetected){
        lastDetected = code;
        detText.textContent = code;
        barcodeInput.value = code;
        fillFromBarcode(code);
      }
    }
  }catch(e){
    // ignore
  }
  requestAnimationFrame(scanLoopBarcodeDetector);
}

// ZXing fallback
function runZXing(){
  status.textContent = "Using ZXing fallback (may require internet).";
  log("Starting ZXing fallback");
  const codeReader = new ZXing.BrowserBarcodeReader();
  scanner = codeReader;
  // use decodeFromVideoDevice with environment camera (prefers back)
  const tryStart = async ()=>{
    try{
      await codeReader.decodeFromVideoDevice(null, video, (result, err)=>{
        if(result){
          const code = result.text;
          if(code && code !== lastDetected){
            lastDetected = code;
            detText.textContent = code;
            barcodeInput.value = code;
            fillFromBarcode(code);
            log("ZXing detected: "+code);
          }
        }
        if(err && !(err instanceof ZXing.NotFoundException)){
          // other errors possible
        }
      });
    }catch(e){
      log("ZXing decodeFromVideoDevice error: "+e);
    }
  };
  tryStart();
}

// small helper: manual paste event handler
barcodeInput.addEventListener('change', (e)=>{ const code = e.target.value.trim(); if(code) fillFromBarcode(code); });

// quick auto-start if loaded in modern browser:
window.addEventListener('load', ()=>{
  // optional: auto-start on load for convenience on own device
  // startCamera();
});
</script>
</body>
</html>
